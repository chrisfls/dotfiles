pkgname=sublime-merge
pkgver=2091
pkgrel=2
pkgdesc='Meet a new Git Client, from the makers of Sublime Text'
arch=('x86_64')
url='https://www.sublimemerge.com'
license=('custom')
depends=('gtk3')
makedepends=('tinyxxd')
source=("https://download.sublimetext.com/sublime_merge_build_${pkgver}_x64.tar.xz"
        "https://download.sublimetext.com/sublime_merge_build_${pkgver}_x64.tar.xz.asc")
b2sums=('5027eb92f6a67764bba7928469cc2fb53478946a5ab1121a8ea6e8096c191e09fbe62cce6dfca1ec60a87f0eac60a971e6a53f0a5049a45ad97e27a1d407edcf'
        'SKIP')
validpgpkeys=('1EDDE2CDFC025D17F6DA9EC0ADAE6AD28A8F901A')

package() {
  cd sublime_merge

  xxd -c 0 -p sublime_merge > "sublime_merge.txt"

  orig=$(cat sublime_merge.txt | grep -oP '554157415641554154534881ec..240000')

  if [ -z "$orig" ]; then
    echo "Failed to find offset" >&2
    exit 1
  fi

  sed -i "s;$orig;48c7c001000000c3${orig:16};g" "sublime_merge.txt"

  if [ $? -ne 0 ]; then
    echo "Failed to apply patch 1" >&2
    exit 1
  fi

  sed -i 's;ba88130000e8........;ba881300009090909090;g' "sublime_merge.txt"

  if [ $? -ne 0 ]; then
    echo "Failed to apply patch 2" >&2
    exit 1
  fi

  sed -i 's;ba983a0000e8........;ba983a00009090909090;g' "sublime_merge.txt"

  if [ $? -ne 0 ]; then
    echo "Failed to apply patch 3" >&2
    exit 1
  fi

  sed -i 's;f04883c4085b415ec3..56534881ec1803;f04883c4085b415ec3c356534881ec1803;g' "sublime_merge.txt" # '..' should be '41'

  if [ $? -ne 0 ]; then
    echo "Failed to apply patch 4" >&2
    exit 1
  fi

  sed -i 's;c3488d05fbcc5400c3..4156534189f648;c3488d05fbcc5400c3c34156534189f648;g' "sublime_merge.txt" # '..' should be '55'

  if [ $? -ne 0 ]; then
    echo "Failed to apply patch 5" >&2
    exit 1
  fi

  xxd -c 0 -r -p sublime_merge.txt > "sublime_merge"
  chmod +x "sublime_merge"
  rm sublime_merge.txt

  install -dm755 "${pkgdir}"/usr/bin

  # Install binaries
  install -Dm755 -t "${pkgdir}"/opt/sublime_merge/ \
    crash_handler \
    git-credential-sublime \
    ssh-askpass-sublime \
    sublime_merge

  # link executable to /usr/bin/
  ln -s /opt/sublime_merge/sublime_merge "${pkgdir}"/usr/bin/smerge

  # copy misc files
  cp --preserve=mode -r -t "${pkgdir}"/opt/sublime_merge/ \
    changelog.txt \
    Packages \
    Icon

  # link app icons to system folder
  for res in 256x256 128x128 48x48 32x32 16x16; do
    install -dm755 "${pkgdir}"/usr/share/icons/hicolor/${res}/apps
    ln -s /opt/sublime_merge/Icon/${res}/sublime-merge.png "${pkgdir}"/usr/share/icons/hicolor/${res}/apps/sublime-merge.png
  done

  # install desktop file
  install -Dm644 -t "${pkgdir}"/usr/share/applications/ "${srcdir}"/sublime_merge/sublime_merge.desktop
}
